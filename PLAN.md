# HelpHub - ポートフォリオ用Webアプリケーション計画書

## 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロジェクト名 | HelpHub |
| 種別 | 社内ヘルプデスク＆ナレッジ管理アプリケーション |
| 目的 | 社内問い合わせの一元管理と、解決ノウハウの蓄積・共有を実現する |
| デモURL | https://helphub-pink.vercel.app |
| リポジトリ | https://github.com/Kujara-jp/helphub |

### 想定利用シーン

- 社内IT部門への問い合わせ（アカウント・ネットワーク・ソフトウェア等）
- 問い合わせ対応の進捗管理（ステータス・優先度の可視化）
- 過去の解決事例をナレッジ記事として蓄積し、自己解決を促進

---

## 2. 技術スタック

| レイヤー | 技術 |
|----------|------|
| フロントエンド | Next.js 16 / React 19 / TypeScript |
| スタイリング | Tailwind CSS 4 |
| バックエンド / DB | Supabase (PostgreSQL) |
| 認証 | Supabase Auth (Email/Password) |
| ファイルストレージ | Supabase Storage |
| デプロイ | Vercel |
| 最適化 | React Compiler |

### 技術選定の理由

- **Next.js**: App Routerによるファイルベースルーティング、SSR/CSRの柔軟な切替が可能
- **Supabase**: PostgreSQLベースでRLS（行レベルセキュリティ）による堅牢な権限制御を実現
- **Tailwind CSS**: ユーティリティファーストで高速なUI開発が可能
- **Vercel**: Next.jsとの親和性が高く、CI/CD込みのデプロイが容易

---

## 3. アーキテクチャ

```
┌─────────────────────────────────────────────────────┐
│                    Vercel (Hosting)                  │
│  ┌───────────────────────────────────────────────┐  │
│  │              Next.js App Router                │  │
│  │  ┌─────────┐  ┌──────────┐  ┌─────────────┐  │  │
│  │  │ ページ   │  │ Server   │  │ Client      │  │  │
│  │  │ ルート   │  │ Actions  │  │ Components  │  │  │
│  │  └─────────┘  └──────────┘  └─────────────┘  │  │
│  └───────────────────┬───────────────────────────┘  │
│                      │                               │
└──────────────────────┼───────────────────────────────┘
                       │ HTTPS
         ┌─────────────▼─────────────┐
         │       Supabase            │
         │  ┌──────┐ ┌───────────┐  │
         │  │ Auth │ │ PostgreSQL│  │
         │  └──────┘ │  + RLS    │  │
         │           └───────────┘  │
         │  ┌──────────────────┐    │
         │  │    Storage       │    │
         │  │ (添付ファイル)    │    │
         │  └──────────────────┘    │
         └──────────────────────────┘
```

---

## 4. データベース設計

### テーブル一覧

| テーブル名 | 説明 |
|-----------|------|
| profiles | ユーザー情報（role: admin / agent / user） |
| tickets | 問い合わせチケット |
| categories | チケットカテゴリ（アカウント・ネットワーク等） |
| ticket_comments | チケットへのコメント（スレッド形式） |
| ticket_events | チケットの変更履歴（監査ログ） |
| ticket_attachments | チケット添付ファイルのメタデータ |
| knowledge_articles | ナレッジ記事 |

### 主要テーブル構成

**tickets**
| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| title | text | タイトル |
| description | text | 本文 |
| status | text | ステータス（new / open / in_progress / pending / waiting / user_action / resolved / closed） |
| priority | text | 優先度（high / medium / low） |
| impact | text | 影響範囲（self / team / organization） |
| category_id | uuid | カテゴリFK |
| assigned_to | uuid | 担当者FK（任意） |
| requester_id | uuid | 作成者FK |
| requester_name | text | 問い合わせ者名（任意） |
| requester_department | text | 所属部署（任意） |
| created_at | timestamptz | 作成日時 |

**knowledge_articles**
| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| title | text | タイトル |
| body | text | 本文 |
| tags | text[] | タグ配列 |
| source_ticket_id | uuid | 元チケットFK（任意） |
| created_by | uuid | 作成者FK |
| created_at | timestamptz | 作成日時 |

### RLS（行レベルセキュリティ）ポリシー

- **チケット**: 自身の作成チケットのみ閲覧可。admin/agentは全件閲覧可
- **添付ファイル**: 自身のファイルのみ閲覧・削除可。admin/agentは全件操作可
- **削除制限**: チケット削除は作成者本人は作成当日のみ、admin/agentは日付制限なし（Asia/Tokyoタイムゾーン基準）

---

## 5. 機能一覧

### 5.1 認証機能

| 機能 | 説明 | ロール |
|------|------|--------|
| サインアップ | メール/パスワードで新規登録 | 全員 |
| ログイン | メール/パスワードで認証 | 全員 |
| セッション管理 | Cookie基盤のサーバーサイドセッション | - |
| リダイレクト制御 | ログイン後に元のページへ安全に遷移 | - |

### 5.2 チケット管理

| 機能 | 説明 | ロール |
|------|------|--------|
| チケット一覧 | 全チケットの一覧表示 | 全員 |
| チケット作成 | タイトル・説明・優先度・カテゴリ・添付ファイル付きで投稿 | 全員 |
| チケット詳細 | 内容・添付画像・コメント・変更履歴の表示 | 全員 |
| コメント投稿 | チケットへの返信・議論 | 全員 |
| チケット削除 | 作成者本人は作成当日のみ削除可能。admin/agentは日付制限なし | 作成者 / admin / agent |
| 一括削除 | 管理者が自分のデモチケットを一括削除 | admin |
| ファイル添付 | 画像最大3枚（各5MB）、D&D/ペースト対応 | 全員 |

### 5.3 スタッフダッシュボード

| 機能 | 説明 | ロール |
|------|------|--------|
| 受信トレイ | 全チケットのフィルタ付き一覧 | admin / agent |
| ステータス変更 | インライン操作で即時更新 | admin / agent |
| 優先度変更 | インライン操作で即時更新 | admin / agent |
| カテゴリ変更 | インライン操作で即時更新 | admin / agent |
| 変更履歴記録 | 操作の自動監査ログ | - |
| ロール管理 | ユーザーのロール（admin/agent/user）変更 | admin |

### 5.4 ナレッジベース

| 機能 | 説明 | ロール |
|------|------|--------|
| 記事一覧 | 全文検索・タグフィルタ付き | 全員 |
| 記事作成 | テンプレート付きエディタ（問題・原因・対策・予防） | admin / agent |
| 記事詳細 | タグ・本文・ソースチケットの表示 | 全員 |
| チケット連携 | チケット詳細画面からナレッジ記事を直接作成 | admin / agent |

---

## 6. 画面構成

```
/                    トップページ（機能紹介）
/login               ログイン / サインアップ
/tickets             チケット一覧 + 作成フォーム
/tickets/[id]        チケット詳細（コメント・変更履歴・添付ファイル）
/knowledge           ナレッジ記事一覧（検索・タグフィルタ）
/knowledge/new       ナレッジ記事作成（スタッフ専用）
/knowledge/[id]      ナレッジ記事詳細
/staff               スタッフ受信トレイ（スタッフ専用）
```

---

## 7. セキュリティ対策

| 対策 | 実装方法 |
|------|----------|
| 認証 | Supabase Auth（セッション＋Cookie） |
| 認可 | RLS による行レベルアクセス制御 |
| オープンリダイレクト防止 | `safeNextPath` によるURLパス検証 |
| ファイルアクセス制御 | Signed URL（1時間有効期限） |
| ロールベース表示制御 | ランタイムでのロール判定 + RLSによる二重防御 |
| 自己権限昇格防止 | WITH CHECK で非adminのrole変更を拒否 |
| RLS無限再帰防止 | `current_role()` を SECURITY DEFINER で定義し、自己参照ループを回避 |
| ナレッジ記事アクセス制御 | RLSで認証済みユーザーのみ閲覧・作成可（匿名アクセス不可） |
| 監査ログ改ざん防止 | ticket_events INSERT時に `actor_id = auth.uid()` を強制し、なりすまし記録を防止 |
| チケット作成の原子性 | insert+upload成功後はロールバック対象外とし、一覧再取得失敗でも作成済みデータを保全 |
| FK参照整合性 | ナレッジ記事作成時、元チケットが実在する場合のみ `source_ticket_id` を設定 |

---

## 8. 開発環境・運用

| 項目 | 内容 |
|------|------|
| パッケージ管理 | npm |
| リンター | ESLint 9 (Next.js config) |
| 型チェック | TypeScript strict mode |
| デプロイ | Vercel（GitHub連携による自動デプロイ） |
| 環境変数 | `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY` |
| タイムゾーン | Asia/Tokyo（日付表示・RLSポリシー共通） |

---

## 9. 今後の拡張案（ロードマップ）

### Phase 1 - 品質向上
- [x] レスポンシブデザインの最適化（モバイル対応強化）
- [ ] ローディング/エラー状態のUI改善
- [ ] テストコードの追加（Jest / Playwright）

### Phase 2 - 機能拡張
- [ ] ナレッジ記事の編集・削除機能
- [ ] チケットの担当者アサイン機能
- [ ] ダッシュボード（統計・グラフ表示）
- [ ] メール/Slack通知連携

### Phase 3 - 高度な機能
- [ ] AI による問い合わせ自動分類・回答候補提示
- [ ] ナレッジ記事のレコメンド機能
- [ ] 多言語対応（i18n）

---

## 10. ポートフォリオとしてのアピールポイント

### 技術面
1. **最新技術の活用**: Next.js 16 / React 19 / React Compiler など最新バージョンを採用
2. **型安全性**: TypeScript strict modeによる堅牢な型チェック
3. **セキュリティ設計**: RLSによる行レベルセキュリティ、オープンリダイレクト防止等
4. **サーバー/クライアント分離**: Server ActionsとClient Componentsの適切な使い分け

### 設計面
5. **実用的なドメイン**: 実際の業務で使えるヘルプデスクシステム
6. **ロールベースアクセス制御**: admin / agent / user の3段階権限設計
7. **監査ログ**: チケット変更の自動追跡による運用透明性
8. **チケット→ナレッジ連携**: 問い合わせ対応からナレッジ蓄積への自然なワークフロー

### UX面
9. **日本語ファースト**: 全UIテキストの日本語対応
10. **直感的な操作**: ドラッグ&ドロップ、ペースト、インライン編集等

---

*最終更新: 2026-02-17*
